# è¯¦ç»†ä»»åŠ¡è¯´æ˜
1. lesson_pack è®²è§£ç¨¿ç»“æ„åŒ–ï¼ˆJSON åˆ†ç¯èŠ‚ï¼‰
2. Router v3 å¼•å…¥ `mode_chat` ç‰¹å¾å¢å¼º

---

## ä¸€ã€lesson_pack è®²è§£ç¨¿ç»“æ„åŒ–ï¼ˆåˆ†ç¯èŠ‚ JSONï¼‰

### ğŸ¯ ç›®æ ‡

ç°åœ¨ lesson_pack å·²ç»ä¼šè¾“å‡ºï¼š

* Topic
* Objectives
* Outline
* Board
* Contentï¼ˆæ•´å—è®²è§£ç¨¿ï¼‰
* Exercises

ä¸‹ä¸€æ­¥æƒ³åšåˆ°ï¼š

* åœ¨ `LessonExplainStep` é‡Œï¼Œ**æŒ‰æ•™å­¦æµç¨‹çš„æ¯ä¸ªç¯èŠ‚è¾“å‡ºç»“æ„åŒ– JSON**ï¼Œä¾‹å¦‚ï¼š

```json
{
  "topic": "åˆ†æ•°çš„åŸºæœ¬æ¦‚å¿µ",
  "grade": "å°å­¦Xå¹´çº§",
  "sections": [
    {
      "name": "å¯¼å…¥",
      "teacher_say": "...",
      "student_may_say": "...",
      "tips": "..."
    },
    {
      "name": "æ–°æˆ",
      "teacher_say": "...",
      "examples": ["ä¾‹1...", "ä¾‹2..."]
    },
    {
      "name": "ç»ƒä¹ ",
      "teacher_say": "...",
      "questions": ["ç»ƒä¹ 1...", "ç»ƒä¹ 2..."]
    },
    {
      "name": "å°ç»“",
      "teacher_say": "...",
      "key_points": ["è¦ç‚¹1...", "è¦ç‚¹2..."]
    }
  ]
}
```

è¿™æ ·ä»¥åä½ å¯ä»¥ï¼š

* åœ¨ CLI ä¸­é€‰æ‹©â€œæ‰“å° JSONâ€æˆ–â€œæ¸²æŸ“æˆæ›´ç¾è§‚çš„æ–‡æœ¬â€ï¼›
* åœ¨è¯„æµ‹è„šæœ¬ä¸­ **è‡ªåŠ¨æ£€æŸ¥æ¯ä¸ªç¯èŠ‚æ˜¯å¦å­˜åœ¨ã€æ˜¯å¦æœ‰ä¾‹å­**ï¼ˆæ¯”å¦‚â€œæ˜¯å¦æœ‰è‡³å°‘ 1 ä¸ªä¾‹é¢˜â€ï¼‰ï¼›
* ä¸ºå°†æ¥åš Web UI æˆ–å¯¼å‡ºä¸ºæ•™æ¡ˆæ¨¡æ¿æ‰“åŸºç¡€ã€‚

### ğŸ“ ç»™ç¼–è¾‘å™¨çš„å®ç°è¯´æ˜

#### 1. State æ‰©å±•

åœ¨ `mm_orch/state.py` ä¸­è¡¥å……ä¸€ä¸ªå­—æ®µï¼Œä¸“é—¨æ”¾ç»“æ„åŒ–è®²è§£ï¼š

```python
from typing import Any, Dict

@dataclass
class State:
    ...
    lesson_explain_structured: Dict[str, Any] = field(default_factory=dict)
```

#### 2. LessonExplainStepï¼šè¾“å‡º JSON æ ¼å¼

åœ¨ `mm_orch/steps.py` çš„ `LessonExplainStep` ä¸­ï¼š

1. æ„é€  prompt æ—¶ï¼Œä¸å†åªè¦æ±‚æ™®é€šæ–‡æœ¬ï¼Œè€Œæ˜¯æ˜ç¡®è¦æ±‚è¾“å‡º **åˆæ³• JSON**ï¼š

   ```text
   ä½ æ˜¯ä¸€åå°å­¦è€å¸ˆï¼Œè¯·æ ¹æ®ä¸‹é¢çš„æ•™å­¦è®¾è®¡ç”Ÿæˆä¸€ä»½ç»“æ„åŒ–çš„è¯¾å ‚è®²è§£æ–¹æ¡ˆã€‚

   ã€è¯¾é¢˜ã€‘
   {lesson_topic}

   ã€æ•™å­¦ç›®æ ‡ã€‘
   {lesson_objectives}

   ã€æ•™å­¦æµç¨‹ã€‘
   {lesson_outline}

   ã€æ¿ä¹¦è®¾è®¡ã€‘
   {board_plan}

   è¦æ±‚ï¼š
   1. è¾“å‡ºä¸ºä¸€ä¸ªåˆæ³•çš„ JSON å¯¹è±¡ï¼Œä¸è¦æ·»åŠ ä»»ä½•è§£é‡Šæ–‡å­—æˆ–å¤šä½™å†…å®¹ã€‚
   2. JSON é¡¶å±‚å­—æ®µï¼š
      - "topic": stringï¼Œè¯¾é¢˜åç§°
      - "grade": stringï¼Œå¯ä»¥æ ¹æ®æè¿°çŒœæµ‹ï¼Œä¾‹å¦‚ "å°å­¦Xå¹´çº§"
      - "sections": æ•°ç»„ï¼Œæ¯ä¸ªå…ƒç´ æ˜¯ä¸€ä¸ªç¯èŠ‚å¯¹è±¡ï¼Œç»“æ„å¦‚ä¸‹ï¼š
        - "name": stringï¼Œç¯èŠ‚åç§°ï¼Œä¾‹å¦‚ "å¯¼å…¥"ã€"æ–°æˆ"ã€"ç»ƒä¹ "ã€"å°ç»“"
        - "teacher_say": stringï¼Œè€å¸ˆåœ¨è¿™ä¸€ç¯èŠ‚çš„è®²è§£ä¸å¼•å¯¼ç”¨è¯­
        - å¯é€‰å­—æ®µï¼š
          - "student_may_say": stringï¼Œå¯èƒ½çš„å­¦ç”Ÿå›åº”æˆ–æ€è€ƒ
          - "examples": æ•°ç»„ï¼Œä¾‹é¢˜æˆ–ç¤ºä¾‹æè¿°
          - "questions": æ•°ç»„ï¼Œè¯¾å ‚æé—®æˆ–ç»ƒä¹ é¢˜
          - "key_points": æ•°ç»„ï¼Œæœ¬ç¯èŠ‚éœ€è¦å¼ºè°ƒçš„è¦ç‚¹

   è¯·åªè¾“å‡º JSONï¼Œä¸è¦åŒ…å«åå¼•å·ã€æ³¨é‡Šæˆ–å…¶å®ƒæ–‡æœ¬ã€‚
   ```

2. ä½¿ç”¨ `generator_chat` è°ƒç”¨ Qwen Chat æ¨¡å‹ç”Ÿæˆæ–‡æœ¬åï¼š

   * ä½¿ç”¨ `clean_prompt` åçš„æ–‡æœ¬å°è¯• `json.loads` è§£æï¼›
   * è‹¥è§£ææˆåŠŸï¼Œåˆ™å†™å…¥ `state.lesson_explain_structured`ï¼›
   * åŒæ—¶å¯ä»¥å°† JSON æ¸²æŸ“ä¸ºè‡ªç„¶è¯­è¨€æ•™å­¦ç¨¿å­˜åˆ° `state.teaching_text`ï¼ˆå…¼å®¹ç°æœ‰å±•ç¤ºï¼‰ï¼š

     * ä¾‹å¦‚éå† `sections`ï¼ŒæŒ‰ `name + teacher_say + examples` æ‹¼æˆå¤šæ®µè½æ–‡æœ¬ã€‚

3. å¦‚æœ JSON è§£æå¤±è´¥ï¼š

   * å¯ä»¥é€€å›ä¸€ç‰ˆâ€œæ™®é€šæ–‡æœ¬è®²è§£â€ï¼ŒåŒæ—¶åœ¨ trace é‡Œè®°ä¸€ä¸ª `parse_error=true` çš„ flagï¼›
   * ä¹Ÿå¯ä»¥ç®€å•å°è¯•ç”¨ `strip`ã€å»æ‰å¼€å¤´/ç»“å°¾å¤šä½™å­—ç¬¦åå† parse ä¸€æ¬¡ã€‚

#### 3. CLI å±•ç¤ºç»“æ„åŒ–è®²è§£

åœ¨ `mm_orch/main.py` ä¸­ï¼Œlesson_pack è¾“å‡ºéƒ¨åˆ†ï¼š

* åŸæœ‰ï¼š

  ```text
  === Lesson Content ===
  {teaching_text}

  === Exercises ===
  {exercises}
  ```

* å¯ä»¥å¢åŠ ä¸€ä¸ªâ€œç»“æ„åŒ–è§†å›¾â€ï¼ˆå¯é€‰ï¼‰ï¼š

  ```text
  === Lesson Structured Sections ===
  Section 1: {name}
    Teacher: {teacher_say}
    Examples: ...
    Key points: ...

  Section 2: ...
  ```

åŒæ—¶ä¿ç•™åŸæœ‰ `Lesson Content` æ–¹ä¾¿ç›´æ¥é˜…è¯»ã€‚

#### 4. è¯„æµ‹è„šæœ¬å¯ä»¥åˆ©ç”¨ JSON

åé¢ä½ è¦åšè¯„æµ‹æ—¶ï¼Œå¯ä»¥åœ¨ eval è„šæœ¬é‡Œç”¨ï¼š

* è‡³å°‘æœ‰ 3 ä¸ª sectionï¼›
* è‡³å°‘æœ‰ 1 ä¸ª section ååŒ…å«â€œç»ƒä¹ â€ï¼›
* æ€»çš„ `examples` æ•°é‡ â‰¥ 1ï¼›
  ç­‰ç­‰è¿™äº›è‡ªåŠ¨æŒ‡æ ‡ã€‚

---

## äºŒã€Router v3 ç‰¹å¾å¢å¼ºï¼šåŠ å…¥ mode_chat one-hot

ä½ å·²ç»åœ¨ state.meta é‡Œæœ‰äº†ï¼š

```python
state.meta["mode"] = "chat"
```

ç°åœ¨è¦è®© router v3 åœ¨è®­ç»ƒå’Œé¢„æµ‹æ—¶éƒ½â€œçœ‹è§â€è¿™ä¸ªç‰¹å¾ï¼Œä»è€Œï¼š

* chat åœºæ™¯ä¸‹æ›´ç¨³å®šåœ°é€‰æ‹© `chat_generate` / `lesson_pack` ç­‰åˆé€‚å·¥ä½œæµï¼›
* æœç´¢/ä»»åŠ¡ç±»é—®é¢˜ä»ç„¶å¯ç”¨ search_qa / rag_qa / summarize ç­‰ã€‚

### ğŸ’¡ æ€»ä½“æ€è·¯

1. åœ¨ router v3 çš„è®­ç»ƒè„šæœ¬ä¸­ï¼ŒæŠŠ `mode_chat` ä½œä¸ºä¸€ä¸ªé¢å¤–çš„ç‰¹å¾ï¼ˆone-hotï¼‰ã€‚
2. åœ¨é¢„æµ‹æ—¶ï¼Œå¯¹æ–°æ ·æœ¬ä¹Ÿæ„é€ ç›¸åŒç‰¹å¾ã€‚
3. è®© Logistic Regression/å…¶ä»–æ¨¡å‹ç”¨è¿™äº›ç‰¹å¾ä¸€èµ·åšå†³ç­–ã€‚

### ğŸ§© ç»™ç¼–è¾‘å™¨çš„å…·ä½“è¯´æ˜

#### 1. è®­ç»ƒè„šæœ¬ï¼šscripts/train_router_v3.py

åœ¨è¯»å– trace å¹¶æ„é€ ç‰¹å¾æ—¶ï¼Œç›®å‰ä½ å¤§æ¦‚ä¼šæœ‰ç±»ä¼¼ï¼š

```python
X_texts = [sample["question"] for sample in samples]
# ä½¿ç”¨ TF-IDF ä¹‹ç±»åšå‘é‡
```

ç°åœ¨è¦ï¼š

1. ä»æ¯æ¡æ ·æœ¬é‡Œå–å‡º `meta.mode`ï¼š

   ```python
   modes = [sample.get("meta", {}).get("mode", "default") for sample in samples]
   ```

2. å°† `mode` ç¼–æˆç®€å•çš„ one-hot æˆ–äºŒå€¼ç‰¹å¾ï¼Œå¦‚ï¼š

   ```python
   mode_is_chat = [1 if m == "chat" else 0 for m in modes]
   ```

3. æ„é€ æœ€ç»ˆç‰¹å¾æ—¶ï¼Œæœ‰ä¸¤ç§æ–¹æ¡ˆï¼š

   * ğŸ…° **ç®€å•æ‹¼æ¥**ï¼š

     * ç”¨ TF-IDF å¾—åˆ° `X_text`ï¼ˆshape = [n_samples, d]ï¼‰
     * ç”¨ `np.array(mode_is_chat).reshape(-1, 1)` å¾—åˆ° `X_mode`
     * æœ€ç»ˆ `X = np.hstack([X_text.toarray(), X_mode])`
     * ç„¶åç”¨ `LogisticRegression` æ‹Ÿåˆã€‚

   * ğŸ…± ä½¿ç”¨ sklearn çš„ `ColumnTransformer`/`FeatureUnion`ï¼Œä½†å¯¹å½“å‰é¡¹ç›®æ¥è¯´ ğŸ…° å·²ç»å¤Ÿç”¨ã€‚

> âš  æ³¨æ„ï¼šä¿å­˜æ¨¡å‹æ—¶è¦è®°å½•ä¸‹è¿™ä¸ªæ¨¡å¼ç‰¹å¾çš„å­˜åœ¨ï¼Œæ¯”å¦‚å†™å…¥ `router_v3_meta.json` å‘Šè¯‰æ¨ç†æ—¶éœ€è¦é™„åŠ  1 ç»´ mode ç‰¹å¾ã€‚

#### 2. æ¨ç†ï¼šmm_orch/router_v3.py

åœ¨é¢„æµ‹ï¼ˆ`predict` æˆ– `route`ï¼‰å‡½æ•°é‡Œï¼š

1. ä¸€æ ·ä» state/meta ä¸­å–ï¼š

   ```python
   mode = state.meta.get("mode", "default")
   mode_is_chat = 1 if mode == "chat" else 0
   ```

2. ç”¨ä¸ä½ è®­ç»ƒæ—¶ç›¸åŒçš„æ–¹å¼æ„é€ ç‰¹å¾å‘é‡ï¼š

   ```python
   X_text = vectorizer.transform([question_text])
   X = np.hstack([X_text.toarray(), np.array([[mode_is_chat]])])
   probs = clf.predict_proba(X)[0]
   ```

3. æŒ‰ç…§æ¦‚ç‡ + costï¼ˆ`router_v3_costs.json`ï¼‰æ’åºå¾—åˆ°å€™é€‰ workflowã€‚

> å¦‚æ­¤ä¸€æ¥ï¼Œè·¯ç”±å™¨å°±ä¼šâ€œæ„è¯†åˆ°â€ï¼š
>
> * åŒä¸€ç±»æ–‡æœ¬ï¼Œåœ¨ `mode=chat` æƒ…å†µä¸‹æ›´é€‚åˆé€‰ `chat_generate`ï¼›
> * åœ¨ `mode=default` æˆ– `mode=None` æƒ…å†µä¸‹ï¼Œåˆ™æŒ‰æ™®é€š search_qa/rag_qa/summarize çš„ç»éªŒæ¥åˆ¤æ–­ã€‚

---

## ä¸‰ã€å¯ä»¥ä½œä¸ºâ€œç¬¬ä¸ƒç‰ˆä¹‹åçš„ TODOâ€å°åˆ—è¡¨ï¼ˆä½ å¯ä»¥ç›´æ¥è´´åˆ° docs/éœ€æ±‚æ–‡æ¡£ï¼‰

> **ç¬¬å…«ç‰ˆä¼˜å…ˆä»»åŠ¡å»ºè®®ï¼š**
>
> 1. **lesson_pack è®²è§£ç¨¿ç»“æ„åŒ–**
>
>    * åœ¨ `LessonExplainStep` ä¸­ï¼Œå°†è®²è§£ç¨¿è¾“å‡ºä¸º JSON ç»“æ„ï¼š
>
>      * é¡¶å±‚å­—æ®µï¼štopic, grade, sections[]
>      * æ¯ä¸ª section åŒ…å« name/teacher_say ç­‰å­—æ®µã€‚
>    * è§£æ JSON å¹¶ä¿å­˜åˆ° `state.lesson_explain_structured`ã€‚
>    * CLI åœ¨ lesson_pack æ¨¡å¼ä¸‹å¢åŠ â€œç»“æ„åŒ–ç« èŠ‚è§†å›¾â€çš„æ‰“å°ã€‚
> 2. **Router v3 æ¨¡å¼ç‰¹å¾å¢å¼º**
>
>    * åœ¨ `scripts/train_router_v3.py` ä¸­ï¼Œå¼•å…¥ `mode` ç‰¹å¾ï¼š
>
>      * ä» trace è¯»å– `meta.mode`ï¼Œæ„é€  `mode_is_chat` ç‰¹å¾ã€‚
>      * å°†è¯¥ç‰¹å¾ä¸ TF-IDF ç‰¹å¾æ‹¼æ¥åè®­ç»ƒ LogisticRegressionã€‚
>    * åœ¨ `mm_orch/router_v3.py` ä¸­ï¼Œåœ¨ route/predict æ—¶ä½¿ç”¨åŒæ ·æ–¹å¼æ„é€ ç‰¹å¾ï¼ˆå« `mode_is_chat`ï¼‰ã€‚
>    * æ›´æ–° router_v3 meta æ–‡ä»¶ï¼Œæ ‡è®°å½“å‰ä½¿ç”¨çš„ç‰¹å¾æ–¹æ¡ˆï¼Œä»¥å…¼å®¹æœªæ¥å‡çº§ã€‚
> 3. ï¼ˆå¯é€‰ï¼‰åœ¨ eval è„šæœ¬ä¸­ï¼Œå¢åŠ å¯¹ lesson_pack ç»“æ„åŒ–è¾“å‡ºçš„è‡ªåŠ¨æ£€æŸ¥ï¼Œä¾‹å¦‚ï¼š
>
>    * `sections` æ•°é‡ â‰¥ 3ï¼›
>    * å­˜åœ¨åä¸ºâ€œå¯¼å…¥/æ–°æˆ/ç»ƒä¹ /å°ç»“â€çš„è‡³å°‘ 2 ä¸ªç¯èŠ‚ï¼›
>    * è‡³å°‘ä¸€ä¸ª section åŒ…å« examples æˆ– questionsã€‚