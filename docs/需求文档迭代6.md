好，我们正式进入 **下一阶段：把它变成“会聊天、会教课、会用你自己资料”的小老师”**。我分三块来设计，你可以按优先级慢慢交给你的 AI 编辑器。

---

## 总体愿景：V5 = 对话 + 教学场景落地 + 内容质量升级

这一阶段的目标，不再是“系统能跑”，而是：

1. 你可以用 `chat` 模式**像跟助教聊天一样用它**。
2. 它在“备课 / 讲解 / 出题 / 用你自己的资料回答问题”上是真有用。
3. 生成内容不要再像乱飚公众号稿，故事和讲解都要更贴近小学生。

下面所有内容，我都会写成**可以直接丢给编辑器的开发说明**。

---

## 阶段任务概览（可以叫 V5）

1. **Chat 模式完善 + 记忆接入**（对话体验）
2. **教学超级工作流：从课题 → 教案 → 讲解 → 练习题**（教学场景）
3. **本地 RAG 教学资料库：用你自己的讲义来回答问题**（知识沉淀）
4. **内容质量护栏：过滤广告/公众号语气，约束生成风格**（内容质量）

---

## 任务 1：Chat 模式完善 + 记忆接入

> 目标：`python -m mm_orch.chat` 之后，能像和助教对话一样连续多轮聊天，并且它记得最近聊了什么。

### 1.1 Chat REPL 体验打磨

给编辑器说明：

* 在 `mm_orch/chat.py` 或类似入口中：

  * 维持一个 `conversation_id`；
  * 每次用户输入一行，调用 `ConversationManager.handle_turn(conversation_id, user_utterance)`；
  * 打印返回的 `assistant_reply`；
  * 支持输入 `/exit` 退出。

* 确保：

  * 每轮调用都写 trace（含 conversation_id、轮次编号）；
  * Router 能看到当前 query 是来自 chat 模式（例如 `state.meta["mode"] = "chat"`）。

### 1.2 接记忆：让对话有“短期记忆”

给编辑器：

* 在 `ConversationManager` 中：

  * 对每个 `conversation_id` 维护最近 N 轮对话（如 6–8 轮）作为 `short_history`；
  * 在构造 `state.question` 或 `state.memory_context` 时，把 `short_history` 简要拼进去，例如：

    ```text
    [对话历史摘要]
    - 用户：...
    - 助手：...
    （略）

    [当前用户问题]
    ...
    ```

* 把 `memory_context` 字段加进 `State`（如果还没加）：

  * 在每个生成类 Step 的 prompt 里，如果有 `state.memory_context`，就加一段“基于之前对话”的说明。

### 1.3 先不搞复杂长期记忆，专注体验

这一步只做“短期上下文 + 会话 id”，先让你感受到：

* 问：“刚才你说的第二点是什么？” → 它能接上文。
* 问：“我们继续刚才那节课，讲节奏。” → 它知道你在延续同一主题。

长期记忆（总结、存档、个性化画像）可以放到下一阶段。

---

## 任务 2：教学超级工作流（Teacher Workflow）

> 目标：给一个课题，比如“分数加减法，四年级”或者“节奏与四分音符（音乐课）”，它能自动产出：
> 教学目标 → 教学流程 → 板书提纲 → 讲解稿 → 练习题。

命名建议：`workflow = "lesson_pack"`

### 2.1 状态设计

在 `state.py` 中新增字段：

* `lesson_topic`: 课题（如 “分数加减法，四年级”）
* `lesson_objectives`: 教学目标（列表）
* `lesson_outline`: 教学流程分点（导入 → 新授 → 练习 → 总结）
* `board_plan`: 板书提纲
* `teaching_text`: 讲解稿（可以复用现有 `teaching_text`）
* `exercises`: 练习题列表（题目 + 答案）

### 2.2 新工作流：`lesson_pack`

在 `mm_orch/steps.py` 中设计步骤链：

1. `LessonPlanStep`

   * 输入：`question` 里包含课题与年级，如 “分数加减法，四年级” / “四年级音乐课：节奏与四分音符”
   * 输出：

     * `lesson_topic`
     * `lesson_objectives`（3–5 条）
     * `lesson_outline`（3–6 个环节）
     * `board_plan`（板书要写哪些关键词/例题）

2. `LessonExplainStep`

   * 基于 `lesson_outline + board_plan`，生成较长的 `teaching_text`：

     * 用你现在的 TeachExplain 模板做升级版，强调年级、学科（数学/音乐/美术）；

3. `LessonExerciseStep`

   * 根据课题 + 教学目标，生成 5–10 道练习题：

     * 题目类型可混合（选择、填空、解答、开放性创作）；
     * 每题附参考答案；
     * 对艺术/音乐可以生成“听后感/画一幅…”之类开放任务。

### 2.3 CLI & Chat 接入

* 在 `main.py` 中注册 `lesson_pack` 工作流：

  * `python -m mm_orch.main --workflow lesson_pack "四年级数学：分数加减法"`
  * 输出中打印：

    * `lesson_objectives`
    * `lesson_outline`
    * `board_plan`
    * `teaching_text`
    * `exercises`

* 在 chat 模式中，当用户说：

  * “帮我设计一节四年级的分数加减法课” → Router 应倾向选择 `lesson_pack`。

---

## 任务 3：本地教学 RAG 知识库（你的资料 → 它的知识）

> 目标：把你平时的教案、讲义、笔记导入 `.kb`，让它能用这些资料回答问题，比如：“上次那节课你提到的节奏练习是什么？”、“我们班课堂规则有哪些？”

### 3.1 约定一个教学资料目录

* 在项目里约定一个目录，如：`./kb_docs/teaching/`。
* 你可以把：

  * 课堂讲义 `.md`
  * 教案 `.txt`
  * 课程说明 `.md`
    放进去。

### 3.2 扩展 ingest 脚本：支持“标签/学科/年级”

给编辑器：

* 修改 `scripts/ingest_docs.py`：

  * 新增可选参数：

    * `--tag`（如 “math_grade4” / “music_grade3”）
  * 在向量库中，对每个 chunk 记录：

    * `doc_id`
    * `source_path`
    * `tags`（列表）

* 在 `NpyVectorStore` 的 `add_texts` 中增加一个可选 `metadatas` 字段（包含 tags 等），以便将来按 tag 过滤检索。

### 3.3 rag_qa 调整提示，让它更像“老师记事本”

在 `RagAnswerStep` 的 prompt 中：

* 明确说明资料来自“你的教学笔记 / 团队规范 / 教案”；
* 让输出结构清晰，列出要点；
* 对于教学问题，要求：

  * “按照条目回答”；
  * “尽量贴合小学学生能理解的表达”。

---

## 任务 4：内容质量护栏（过滤“公众号体”和广告）

> 目标：继续使用 GPT2 的前提下，尽可能避免出现“天涯论坛、公众号广告、律师事务所招聘”等内容，提升输出的教育感。

### 4.1 Prompt 增加负面约束

在 `StoryGenerateStep` / `TeachingExplainStep` 的 prompt 模板中统一加上：

```text
禁止事项：
- 不要出现任何公众号、微博、论坛、天涯、律师事务所、招聘、广告、版权声明等内容；
- 不要出现“来源：”“作者：”“转载自：”“联系电话”“QQ/微信号”等信息；
- 不要出现网址或类似广告文案；
- 只写故事或课堂讲解正文。
```

### 4.2 生成后做简单过滤（后处理）

在每个生成 Step 结束后，增加一个简单的文本过滤函数：

* 如果检测到以下关键词：

  * “天涯论坛”“来源：”“版权所有”“律师事务所”“微信公众号”“QQ：”“微信号”等
* 可以选择：

  * 直接截断到这些词之前；
  * 或者给这一段打一个较低的 quality score（在 trace 里的 `quality` 字段），方便后续 Router / Generator 训练时惩罚这种输出。

---

## 可以给编辑器的总体任务清单（简写版）

你可以直接贴下面这段给编辑器：

> 请在现有 mm_orch 基础上，按以下方向迭代一版：
>
> 1. **完善 chat 模式**
>
>    * 提供 `python -m mm_orch.chat` 入口，基于 ConversationManager 维护 conversation_id 和最近 N 轮对话。
>    * 每轮调用前，将短期对话摘要写入 `state.memory_context`，在生成类 Step 的 prompt 中使用。
> 2. **新增教学工作流 lesson_pack**
>
>    * 在 state 中加入 lesson_topic/lesson_objectives/lesson_outline/board_plan/teaching_text/exercises。
>    * 新增 LessonPlanStep / LessonExplainStep / LessonExerciseStep，组合成 `lesson_pack` workflow。
>    * main.py 中注册 `--workflow lesson_pack`，CLI 输出完整教案与练习。
> 3. **扩展 RAG 教学知识库**
>
>    * 在 scripts/ingest_docs.py 中支持 `--tag` 参数，把教学文档导入 .kb，并存储 tags。
>    * RagAnswerStep 的 prompt 明确说明资料来自教学笔记/教案，输出按“要点列表”形式回答。
> 4. **内容质量护栏**
>
>    * 在故事/教学的 Prompt 中加入“禁止出现广告、版权声明、论坛/公众号模版句式”的负面约束。
>    * 在 StoryGenerateStep / TeachingExplainStep 生成后做一次关键词过滤，对出现明显广告/来源信息的内容进行截断或质量降权（写入 trace 的质量打分）。
>
> 保持现有模型/Tokenizer 配对与 CUDA 修复逻辑，不要改动 ModelManager 的大结构，只在 workflow 与 prompt、后处理层面增强体验与教育场景适配。

---

如果你愿意，等这一轮做完，你可以给我看看：

* 一次 `lesson_pack` 输出的完整教案；
* 一次 `chat` 模式下的多轮对话片段；

我可以帮你一起**从“真正老师视角”帮你挑 Prompt 和结构，让讲解更像你平时在班里的语言**（比如多一点例子、少一点抽象术语）。
